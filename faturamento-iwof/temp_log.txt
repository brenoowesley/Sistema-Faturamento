commit 3514615f7865e72e976c53210a192a9beadc622e
Author: brenoowesley <breno_wesley@yahoo.com.br>
Date:   Fri Feb 27 17:16:43 2026 -0300

    Update FechamentoLote.tsx

diff --git a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
index b0689e3..8cf83da 100644
--- a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
+++ b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
@@ -91,14 +91,44 @@ export default function FechamentoLote({
         return { reports, orphanNfses, orphanBoletos };
     }, [agendamentos, nfseFiles, boletoFiles]);
 
-    const handleBoletoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
+    const handleBoletoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
         if (!e.target.files?.length) return;
-        const files = Array.from(e.target.files).map(f => ({
-            name: f.name,
-            file: f,
-            fetchUrl: URL.createObjectURL(f)
-        }));
-        setBoletoFiles(prev => [...prev, ...files]);
+        setLoadingMap(p => ({ ...p, "zipBoletos": true }));
+
+        try {
+            const newFiles: { name: string; fetchUrl: string; file: File }[] = [];
+
+            for (const file of Array.from(e.target.files)) {
+                if (file.name.toLowerCase().endsWith(".zip")) {
+                    const jsZip = new JSZip();
+                    const zip = await jsZip.loadAsync(file);
+
+                    for (const [filename, fileData] of Object.entries(zip.files)) {
+                        if (!fileData.dir && filename.toLowerCase().endsWith(".pdf")) {
+                            const blob = await fileData.async("blob");
+                            const extractedFile = new File([blob], filename, { type: "application/pdf" });
+                            newFiles.push({
+                                name: filename,
+                                file: extractedFile,
+                                fetchUrl: URL.createObjectURL(extractedFile)
+                            });
+                        }
+                    }
+                } else if (file.name.toLowerCase().endsWith(".pdf")) {
+                    newFiles.push({
+                        name: file.name,
+                        file: file,
+                        fetchUrl: URL.createObjectURL(file)
+                    });
+                }
+            }
+            setBoletoFiles(prev => [...prev, ...newFiles]);
+        } catch (error) {
+            console.error("Error reading boletos zip/pdf", error);
+            alert("Erro ao processar os arquivos de Boletos.");
+        } finally {
+            setLoadingMap(p => ({ ...p, "zipBoletos": false }));
+        }
     };
 
     const handleNfsZipUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
@@ -289,14 +319,14 @@ export default function FechamentoLote({
                 <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
                     <div className="bg-[var(--bg-card)] border border-[var(--border)] p-6 rounded-2xl max-w-md w-full shadow-2xl">
                         <h3 className="text-xl font-bold mb-2">Enviar Boletos PDF</h3>
-                        <p className="text-sm text-[var(--fg-dim)] mb-6">Você pode soltar os PDFS (mesmo todos juntos) e faremos o cruzamento automático. Tem certeza de enviar?</p>
+                        <p className="text-sm text-[var(--fg-dim)] mb-6">Você pode soltar os PDFs (mesmo todos juntos) ou arquivo <strong>.ZIP</strong> contendo eles, e faremos o cruzamento. Tem certeza de enviar?</p>
 
                         <div className="flex justify-center border-2 border-dashed border-[var(--border)] rounded-xl py-8 mb-6 hover:bg-[var(--bg-sidebar)] transition-colors cursor-pointer" onClick={() => boletosInputRef.current?.click()}>
                             <div className="flex flex-col items-center gap-2">
                                 <UploadCloud className="text-[var(--accent)]" />
-                                <span className="font-bold text-sm">Selecionar Boletos</span>
+                                <span className="font-bold text-sm">{loadingMap["zipBoletos"] ? "Processando arquivos..." : "Selecionar Boletos (PDF/ZIP)"}</span>
                             </div>
-                            <input type="file" ref={boletosInputRef} onChange={handleBoletoUpload} multiple accept=".pdf" className="hidden" />
+                            <input type="file" ref={boletosInputRef} onChange={handleBoletoUpload} multiple accept=".pdf,.zip" className="hidden" />
                         </div>
                         {boletoFiles.length > 0 && <p className="text-xs text-center text-[var(--success)] mb-6 font-bold">{boletoFiles.length} adicionados e cruzados!</p>}
 

commit 502b6a3ddb939ac530d35751aa3cec7e599fdab6
Author: brenoowesley <breno_wesley@yahoo.com.br>
Date:   Fri Feb 27 17:08:07 2026 -0300

    Fiz UI

diff --git a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
index 6dd9390..b0689e3 100644
--- a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
+++ b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
@@ -516,8 +516,10 @@ export default function FechamentoLote({
                             <thead className="bg-[var(--bg-card)] sticky top-0 shadow-sm z-10 border-b border-[var(--border)]">
                                 <tr>
                                     <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold uppercase text-[10px] tracking-wider">Cliente/Faturamento</th>
-                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[200px]">Nota Fiscal (API/ZIP)</th>
-                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[200px]">Boleto/Fatura</th>
+                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[120px]">Valor Boleto</th>
+                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[150px]">Tem NF?</th>
+                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[150px]">Tem NC?</th>
+                                    <th className="py-4 px-6 text-[var(--fg-dim)] font-semibold text-center uppercase text-[10px] tracking-wider w-[180px]">Status E-mail</th>
                                 </tr>
                             </thead>
                             <tbody className="divide-y divide-[var(--border)]">
@@ -530,6 +532,9 @@ export default function FechamentoLote({
                                                 <span className="font-mono text-[10px] font-bold text-[var(--accent)] px-2 rounded-full border border-[var(--accent)]/30 bg-[var(--accent)]/10">{fmtCurrency(r.totalFaturar)}</span>
                                             </div>
                                         </td>
+                                        <td className="py-4 px-6 text-center">
+                                            <span className="font-mono text-[12px] font-bold text-[var(--fg)]">{fmtCurrency(r.totalFaturar)}</span>
+                                        </td>
                                         <td className="py-4 px-6 text-center">
                                             {r.nfse ? (
                                                 <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-green-500/10 text-green-400 border border-green-500/20">
@@ -537,18 +542,23 @@ export default function FechamentoLote({
                                                 </span>
                                             ) : (
                                                 <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-amber-500/10 text-amber-500 border border-amber-500/20">
-                                                    <Info size={12} /> Sem NF Vinculada
+                                                    <Info size={12} /> S/NF
                                                 </span>
                                             )}
                                         </td>
                                         <td className="py-4 px-6 text-center">
-                                            {r.boleto ? (
+                                            <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-[var(--bg-card)] text-[var(--fg-dim)] border border-[var(--border)]">
+                                                — {/* TODO: Future NC mapping integration */}
+                                            </span>
+                                        </td>
+                                        <td className="py-4 px-6 text-center">
+                                            {actionState.emailsSuccess ? (
                                                 <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-green-500/10 text-green-400 border border-green-500/20">
-                                                    <CheckCircle2 size={12} /> {r.boleto.name.length > 20 ? r.boleto.name.substring(0, 18) + '...' : r.boleto.name}
+                                                    <CheckCircle2 size={12} /> Enviado
                                                 </span>
                                             ) : (
-                                                <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-[var(--danger)]/10 text-[var(--danger)] border border-[var(--danger)]/20">
-                                                    <X size={12} /> Pendente
+                                                <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[10px] font-bold bg-[var(--bg-card)] text-[var(--fg-dim)] border border-[var(--border)]">
+                                                    <Mail size={12} /> Pendente
                                                 </span>
                                             )}
                                         </td>

commit 7e44a492cf57d54a317b067b9f5c4d2971dea407
Author: brenoowesley <breno_wesley@yahoo.com.br>
Date:   Fri Feb 27 11:08:33 2026 -0300

    SE DER CERTO, DEU

diff --git a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
index 8a11e8c..6dd9390 100644
--- a/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
+++ b/faturamento-iwof/src/components/faturamento/steps/FechamentoLote.tsx
@@ -12,8 +12,9 @@ interface FechamentoLoteProps {
     nfseFiles: { name: string; blob: Blob; buffer: ArrayBuffer }[]; // Preserving standard nfse state if already generated
     setNfseFiles?: React.Dispatch<React.SetStateAction<{ name: string; blob: Blob; buffer: ArrayBuffer }[]>>;
     financialSummary: FinancialSummary;
-    handleFecharLote: () => Promise<void>;
+    handleFecharLote: () => Promise<void | string>;
     saving: boolean;
+    saveResult?: { ok: number; err: number; loteId?: string } | null;
     periodoInicio: string;
     periodoFim: string;
     nomePasta: string;
@@ -27,6 +28,7 @@ export default function FechamentoLote({
     financialSummary,
     handleFecharLote,
     saving,
+    saveResult,
     periodoInicio,
     periodoFim,
     nomePasta
@@ -124,49 +126,153 @@ export default function FechamentoLote({
         }
     };
 
-    const triggerAction = async (actionKey: string, endpoint: string) => {
-        setLoadingMap(p => ({ ...p, [actionKey]: true }));
+    const handleUploadBoletos = async () => {
+        setLoadingMap(p => ({ ...p, "boletosSuccess": true }));
         try {
-            await new Promise(r => setTimeout(r, 1500)); // Mocking API
-            // const res = await fetch(endpoint, { method: "POST" });
-            // if (!res.ok) throw new Error("API Error");
-            setActionState(p => ({ ...p, [actionKey]: true }));
-        } catch (error) {
-            console.error("Action failed", error);
-            alert("Erro na execução da etapa.");
+            // Se ainda não fechou o lote, fecha agora
+            let targetLoteId = saveResult?.loteId;
+            if (!targetLoteId) {
+                targetLoteId = await handleFecharLote() as string;
+                if (!targetLoteId) throw new Error("Falha ao gerar o lote.");
+            }
+
+            const formData = new FormData();
+            formData.append("loteId", targetLoteId);
+            for (const fileObj of boletoFiles) {
+                formData.append("files", fileObj.file, fileObj.name);
+            }
+
+            const res = await fetch("/api/drive/upload", { method: "POST", body: formData });
+
+            if (!res.ok) {
+                const errData = await res.json().catch(() => ({}));
+                throw new Error(errData.error || "Erro da API ao enviar boletos.");
+            }
+
+            setActionState(p => ({ ...p, boletosSuccess: true }));
+        } catch (error: any) {
+            console.error(error);
+            alert(error.message || "Erro no upload dos boletos");
         } finally {
-            setLoadingMap(p => ({ ...p, [actionKey]: false }));
+            setLoadingMap(p => ({ ...p, "boletosSuccess": false }));
             setActiveModal(null);
         }
     };
 
-    const handleUploadBoletos = async () => {
-        setLoadingMap(p => ({ ...p, "boletosSuccess": true }));
+    const handleUploadNfs = async () => {
+        setLoadingMap(p => ({ ...p, "nfsSuccess": true }));
         try {
-            await handleFecharLote();
-            await new Promise(r => setTimeout(r, 1500));
-            setActionState(p => ({ ...p, boletosSuccess: true }));
-        } catch (error) {
-            alert("Erro no upload dos boletos");
+            let targetLoteId = saveResult?.loteId;
+            if (!targetLoteId) {
+                targetLoteId = await handleFecharLote() as string;
+                if (!targetLoteId) throw new Error("Falha ao gerar o lote.");
+            }
+
+            const formData = new FormData();
+            formData.append("loteId", targetLoteId);
+            for (const fileObj of nfseFiles) {
+                formData.append("files", fileObj.blob, fileObj.name);
+            }
+
+            const res = await fetch("/api/drive/upload", { method: "POST", body: formData });
+            if (!res.ok) {
+                const errData = await res.json().catch(() => ({}));
+                throw new Error(errData.error || "Erro da API ao enviar NFs.");
+            }
+
+            setActionState(p => ({ ...p, nfsSuccess: true }));
+        } catch (error: any) {
+            console.error(error);
+            alert(error.message || "Erro no upload das NFs");
         } finally {
-            setLoadingMap(p => ({ ...p, "boletosSuccess": false }));
+            setLoadingMap(p => ({ ...p, "nfsSuccess": false }));
             setActiveModal(null);
         }
     };
 
-    const handleUploadNfs = async () => triggerAction("nfsSuccess", "/api/documentos/upload-nfs");
-    const handleCriarNCs = async () => triggerAction("ncsSuccess", "/api/documentos/gerar-nc");
-    const handleCriarHCs = async () => triggerAction("hcsSuccess", "/api/documentos/gerar-hc");
+    const handleCriarNCs = async () => {
+        setLoadingMap(p => ({ ...p, "ncsSuccess": true }));
+        try {
+            let targetLoteId = saveResult?.loteId;
+            if (!targetLoteId) {
+                targetLoteId = await handleFecharLote() as string;
+                if (!targetLoteId) throw new Error("Falha ao gerar o lote.");
+            }
+
+            const payload = { loteId: targetLoteId, tipo: "NC" };
+            const res = await fetch("/api/documentos/disparar-gcp", {
+                method: "POST",
+                headers: { "Content-Type": "application/json" },
+                body: JSON.stringify(payload)
+            });
+
+            if (!res.ok) {
+                const errData = await res.json().catch(() => ({}));
+                throw new Error(errData.error || "Erro da API ao gerar NCs.");
+            }
+
+            setActionState(p => ({ ...p, ncsSuccess: true }));
+        } catch (error: any) {
+            console.error(error);
+            alert(error.message || "Erro na geração de NCs");
+        } finally {
+            setLoadingMap(p => ({ ...p, "ncsSuccess": false }));
+            setActiveModal(null);
+        }
+    };
+
+    const handleCriarHCs = async () => {
+        setLoadingMap(p => ({ ...p, "hcsSuccess": true }));
+        try {
+            let targetLoteId = saveResult?.loteId;
+            if (!targetLoteId) {
+                targetLoteId = await handleFecharLote() as string;
+                if (!targetLoteId) throw new Error("Falha ao gerar o lote.");
+            }
+
+            const payload = { loteId: targetLoteId, tipo: "HC" };
+            const res = await fetch("/api/documentos/disparar-gcp", {
+                method: "POST",
+                headers: { "Content-Type": "application/json" },
+                body: JSON.stringify(payload)
+            });
+
+            if (!res.ok) {
+                const errData = await res.json().catch(() => ({}));
+                throw new Error(errData.error || "Erro da API ao gerar HCs.");
+            }
+
+            setActionState(p => ({ ...p, hcsSuccess: true }));
+        } catch (error: any) {
+            console.error(error);
+            alert(error.message || "Erro na geração de HCs");
+        } finally {
+            setLoadingMap(p => ({ ...p, "hcsSuccess": false }));
+            setActiveModal(null);
+        }
+    };
 
     const handleDispararEmails = async () => {
         setLoadingMap(p => ({ ...p, "emailsSuccess": true }));
         try {
-            const res = await fetch("/api/faturamento/disparar-emails", { method: "POST" });
-            if (!res.ok) throw new Error("Erro ao disparar e-mails");
+            let targetLoteId = saveResult?.loteId;
+            if (!targetLoteId) throw new Error("Lote não encontrado. Processe uma das etapas anteriores primeiro.");
+
+            const payload = { loteId: targetLoteId };
+            const res = await fetch("/api/faturamento/disparar-emails", {
+                method: "POST",
+                headers: { "Content-Type": "application/json" },
+                body: JSON.stringify(payload)
+            });
+
+            if (!res.ok) {
+                const errData = await res.json().catch(() => ({}));
+                throw new Error(errData.error || "Erro ao disparar e-mails");
+            }
             setActionState(p => ({ ...p, emailsSuccess: true }));
-        } catch (error) {
+        } catch (error: any) {
             console.error(error);
-            alert("A etapa finalizou com bugs durante envio de e-mail.");
+            alert(error.message || "A etapa finalizou com bugs durante envio de e-mail.");
         } finally {
             setLoadingMap(p => ({ ...p, "emailsSuccess": false }));
             setActiveModal(null);
